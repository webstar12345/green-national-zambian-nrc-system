{% extends 'base.html' %}

{% block title %}My NRC Card - Zambian NRC System{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Your National Registration Card</h1>
        <p class="text-gray-600">NRC Number: <span class="font-semibold text-zambian-green">{{ application.nrc_number }}</span></p>
    </div>

    <!-- Success Message -->
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-2xl mr-3"></i>
            <div>
                <p class="font-semibold">Congratulations! Your NRC has been approved.</p>
                <p class="text-sm">Generated on: {{ application.nrc_generated_at|date:"F d, Y g:i A" }}</p>
            </div>
        </div>
    </div>

    <!-- Card Container -->
    <div class="flex flex-col items-center mb-8">
        <!-- 3D Flip Card -->
        <div class="card-container" id="cardContainer">
            <div class="card" id="nrcCard">
                <!-- Front Side -->
                <div class="card-face card-front">
                    <img src="/media/{{ application.nrc_front_image }}" alt="NRC Front" class="w-full h-full object-contain rounded-lg shadow-2xl">
                </div>
                
                <!-- Back Side -->
                <div class="card-face card-back">
                    <img src="/media/{{ application.nrc_back_image }}" alt="NRC Back" class="w-full h-full object-contain rounded-lg shadow-2xl">
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="mt-8 flex flex-wrap gap-4 justify-center">
            <button onclick="flipCard()" 
                    class="px-6 py-3 bg-zambian-green text-white rounded-lg hover:bg-green-700 transition-colors shadow-md">
                <i class="fas fa-sync-alt mr-2"></i>Flip Card
            </button>
            
            <button onclick="downloadCard('front')" 
                    class="px-6 py-3 bg-zambian-orange text-white rounded-lg hover:bg-orange-600 transition-colors shadow-md">
                <i class="fas fa-download mr-2"></i>Download Front
            </button>
            
            <button onclick="downloadCard('back')" 
                    class="px-6 py-3 bg-zambian-red text-white rounded-lg hover:bg-red-700 transition-colors shadow-md">
                <i class="fas fa-download mr-2"></i>Download Back
            </button>
            
            <button onclick="downloadBothSides()" 
                    class="px-6 py-3 bg-zambian-black text-white rounded-lg hover:bg-gray-800 transition-colors shadow-md">
                <i class="fas fa-file-archive mr-2"></i>Download Both Sides
            </button>
        </div>
    </div>

    <!-- Instructions -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">
            <i class="fas fa-info-circle text-zambian-green mr-2"></i>Instructions
        </h2>
        <ul class="space-y-2 text-gray-700">
            <li class="flex items-start">
                <i class="fas fa-check text-zambian-green mr-2 mt-1"></i>
                <span>Click "Flip Card" to view both sides of your NRC</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-zambian-green mr-2 mt-1"></i>
                <span>Download individual sides or both sides together</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-zambian-green mr-2 mt-1"></i>
                <span>Keep your NRC number safe and secure</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-zambian-green mr-2 mt-1"></i>
                <span>You can print these images for your records</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-zambian-green mr-2 mt-1"></i>
                <span>Visit the nearest registration office to collect your physical NRC card</span>
            </li>
        </ul>
    </div>

    <!-- Back Button -->
    <div class="flex justify-start">
        <a href="{% url 'applications:application_detail' application.pk %}" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Back to Application Details
        </a>
    </div>
</div>

<style>
    .card-container {
        perspective: 1500px;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }

    .card {
        position: relative;
        width: 100%;
        padding-bottom: 63%; /* Aspect ratio for ID card */
        transform-style: preserve-3d;
        transition: transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .card.flipped {
        transform: rotateY(180deg);
    }

    .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .card-front {
        z-index: 2;
    }

    .card-back {
        transform: rotateY(180deg);
    }

    /* Animation for card appearance */
    @keyframes cardAppear {
        from {
            opacity: 0;
            transform: scale(0.8) translateY(20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .card-container {
        animation: cardAppear 0.6s ease-out;
    }

    /* Hover effect */
    .card-container:hover .card {
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
</style>

<script>
    let isFlipped = false;

    function flipCard() {
        const card = document.getElementById('nrcCard');
        isFlipped = !isFlipped;
        
        if (isFlipped) {
            card.classList.add('flipped');
        } else {
            card.classList.remove('flipped');
        }
    }

    function downloadCard(side) {
        let url, filename;
        
        if (side === 'front') {
            url = '/media/{{ application.nrc_front_image }}';
            filename = 'NRC_Front_{{ application.nrc_number }}.png';
        } else {
            url = '/media/{{ application.nrc_back_image }}';
            filename = 'NRC_Back_{{ application.nrc_number }}.png';
        }
        
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = url;
        link.download = filename.replace(/\//g, '_');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message
        showNotification(`${side === 'front' ? 'Front' : 'Back'} side downloaded successfully!`);
    }

    async function downloadBothSides() {
        // Download front
        downloadCard('front');
        
        // Wait a bit then download back
        setTimeout(() => {
            downloadCard('back');
        }, 500);
        
        showNotification('Both sides are being downloaded!');
    }

    function showNotification(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'fixed top-20 right-4 bg-zambian-green text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
        notification.innerHTML = `
            <i class="fas fa-check-circle mr-2"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => {
            notification.style.transition = 'all 0.3s ease-out';
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
        }, 10);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100px)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Auto-flip demonstration on page load
    window.addEventListener('load', () => {
        setTimeout(() => {
            flipCard();
            setTimeout(() => {
                flipCard();
            }, 2000);
        }, 1000);
    });

    // Keyboard shortcut: Space to flip
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            flipCard();
        }
    });
</script>
{% endblock %}